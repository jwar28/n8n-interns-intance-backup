{
  "updatedAt": "2026-02-06T16:10:43.190Z",
  "createdAt": "2025-11-19T07:41:10.913Z",
  "id": "QHxX50oUriQOZZgh",
  "name": "dwh_creation",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "437c3770-7070-4ae6-8397-6a1887eecc7c",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "value": "dwh",
          "mode": "list",
          "cachedResultName": "dwh"
        },
        "table": {
          "__rl": true,
          "value": "dim_social_network",
          "mode": "list",
          "cachedResultName": "dim_social_network"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        0,
        448
      ],
      "id": "c7a6da5e-66bd-4062-b4d1-85583e176df5",
      "name": "Select rows from a table",
      "credentials": {
        "postgres": {
          "id": "re5OmKdxt35y8szi",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DROP SCHEMA dwh CASCADE;\nCREATE SCHEMA dwh;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        0,
        672
      ],
      "id": "bce419c5-46d1-492f-b6e8-9fe4df1b512f",
      "name": "Delete db",
      "credentials": {
        "postgres": {
          "id": "re5OmKdxt35y8szi",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE OR REPLACE PROCEDURE sp_init_dwh(\n    p_start_date DATE,\n    p_end_date   DATE\n)\nLANGUAGE plpgsql\nAS $$\nDECLARE\n    d             DATE;\n    id_int        INTEGER;\n    dow_pg        INTEGER;\n    week          INTEGER;\n    year_start    DATE;\n    dow_start     INTEGER;\n    first_sunday  DATE;\nBEGIN\n    ----------------------------------------------------------------\n    -- Basic validation for date range\n    ----------------------------------------------------------------\n    IF p_start_date IS NULL OR p_end_date IS NULL THEN\n        RAISE EXCEPTION 'Start and end dates must not be NULL';\n    END IF;\n\n    IF p_start_date > p_end_date THEN\n        RAISE EXCEPTION 'Start date (%) must be <= end date (%)',\n            p_start_date, p_end_date;\n    END IF;\n\n    ----------------------------------------------------------------\n    -- 1. Create schema\n    ----------------------------------------------------------------\n    EXECUTE 'CREATE SCHEMA IF NOT EXISTS dwh';\n\n    ----------------------------------------------------------------\n    -- 2. Create STAGING table\n    ----------------------------------------------------------------\n    EXECUTE $sql$\n    CREATE TABLE IF NOT EXISTS dwh.staging_metricool_events (\n        id              BIGSERIAL PRIMARY KEY,\n        brand_id        BIGINT,\n        social_network  VARCHAR(50),\n        endpoint        TEXT,\n        raw_json        JSONB NOT NULL,\n        fetched_at_utc  TIMESTAMPTZ NOT NULL DEFAULT NOW()\n    );\n    $sql$;\n\n    ----------------------------------------------------------------\n    -- 3. Create DIM tables\n    ----------------------------------------------------------------\n\n    -- 3.1 dim_brand\n    EXECUTE $sql$\n    CREATE TABLE IF NOT EXISTS dwh.dim_brand (\n        brand_id            BIGSERIAL PRIMARY KEY,\n        metricool_brand_id  BIGINT UNIQUE,\n        name                VARCHAR(255),\n        page_url            VARCHAR(255),\n        description         TEXT,\n        image_url           TEXT,\n        owner_user_id       BIGINT,\n        is_shared           BOOLEAN,\n        default_timezone    VARCHAR(100),\n        created_at          TIMESTAMPTZ,\n        updated_at          TIMESTAMPTZ DEFAULT NOW()\n    );\n    $sql$;\n\n    -- 3.2 dim_social_network\n    EXECUTE $sql$\n    CREATE TABLE IF NOT EXISTS dwh.dim_social_network (\n        social_network_id   SMALLSERIAL PRIMARY KEY,\n        code                VARCHAR(50) UNIQUE NOT NULL,\n        name                VARCHAR(100) NOT NULL,\n        default_timezone    VARCHAR(100)\n    );\n    $sql$;\n\n    -- 3.3 dim_date\n    EXECUTE $sql$\n    CREATE TABLE IF NOT EXISTS dwh.dim_date (\n        date_id        INTEGER PRIMARY KEY,\n        date           DATE NOT NULL UNIQUE,\n        year           INTEGER NOT NULL,\n        month          INTEGER NOT NULL,\n        day            INTEGER NOT NULL,\n        quarter        INTEGER NOT NULL,\n        week_of_year   INTEGER NOT NULL,\n        day_of_week    INTEGER NOT NULL,\n        month_name     VARCHAR(20),\n        is_weekend     BOOLEAN\n    );\n    $sql$;\n\n    -- 3.4 dim_content\n    EXECUTE $sql$\n    CREATE TABLE IF NOT EXISTS dwh.dim_content (\n        content_id          BIGSERIAL PRIMARY KEY,\n\n        brand_id            BIGINT NOT NULL REFERENCES dwh.dim_brand(brand_id),\n        social_network_id   SMALLINT NOT NULL REFERENCES dwh.dim_social_network(social_network_id),\n\n        -- main post id per network (stable id)\n        external_post_id    VARCHAR(255) NOT NULL,\n\n        -- optional secondary ids (network-specific)\n        network_post_alt_id VARCHAR(255),\n        external_account_id VARCHAR(255),\n\n        content_type        VARCHAR(50),\n\n        -- timestamps\n        published_at_utc    TIMESTAMPTZ,\n        published_timezone  VARCHAR(100),\n\n        -- main text + media\n        text                TEXT,\n        url                 TEXT,\n        picture_url         TEXT,\n\n        is_ai_generated     BOOLEAN NOT NULL DEFAULT FALSE,\n\n        raw_metadata_json   JSONB,\n\n        CONSTRAINT uq_content_network UNIQUE (social_network_id, external_post_id)\n    );\n    $sql$;\n\n    -- Indexes for dim_content\n    EXECUTE $sql$\n    CREATE INDEX IF NOT EXISTS idx_content_brand\n        ON dwh.dim_content (brand_id);\n    $sql$;\n\n    EXECUTE $sql$\n    CREATE INDEX IF NOT EXISTS idx_content_network\n        ON dwh.dim_content (social_network_id);\n    $sql$;\n\n    EXECUTE $sql$\n    CREATE INDEX IF NOT EXISTS idx_content_network_published\n        ON dwh.dim_content (social_network_id, published_at_utc DESC);\n    $sql$;\n\n    ----------------------------------------------------------------\n    -- 4. Create FACT tables\n    ----------------------------------------------------------------\n\n    -- 4.1 social_content_facts\n    EXECUTE $sql$\n    CREATE TABLE IF NOT EXISTS dwh.fact_social_content_metrics (\n        fact_id                 BIGSERIAL PRIMARY KEY,\n\n        content_id              BIGINT NOT NULL REFERENCES dwh.dim_content(content_id),\n        brand_id                BIGINT NOT NULL REFERENCES dwh.dim_brand(brand_id),\n        social_network_id       SMALLINT NOT NULL REFERENCES dwh.dim_social_network(social_network_id),\n\n        snapshot_date_id        INTEGER NOT NULL REFERENCES dwh.dim_date(date_id),\n\n        impressions             INTEGER,\n        reach                   INTEGER,\n        interactions            INTEGER,\n        likes                   INTEGER,\n        comments                INTEGER,\n        shares                  INTEGER,\n        saves                   INTEGER,\n        clicks                  INTEGER,\n        video_views             INTEGER,\n        video_time_watched_sec  DOUBLE PRECISION,\n        engagement_pct          DOUBLE PRECISION,\n\n        extra_metrics           JSONB,\n\n        source_endpoint         TEXT,\n        stats_from_utc          TIMESTAMPTZ,\n        stats_to_utc            TIMESTAMPTZ,\n        loaded_at_utc           TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n\n        CONSTRAINT uq_fact_content_snapshot\n            UNIQUE (content_id, snapshot_date_id, source_endpoint)\n    );\n    $sql$;\n\n    EXECUTE $sql$\n    CREATE INDEX IF NOT EXISTS idx_fact_brand_date\n        ON dwh.fact_social_content_metrics (brand_id, snapshot_date_id);\n    $sql$;\n\n    EXECUTE $sql$\n    CREATE INDEX IF NOT EXISTS idx_fact_content\n        ON dwh.fact_social_content_metrics (content_id);\n    $sql$;\n\n    EXECUTE $sql$\n    CREATE INDEX IF NOT EXISTS idx_fact_network\n        ON dwh.fact_social_content_metrics (social_network_id);\n    $sql$;\n\n    -- Helpful for \"latest snapshot per content\"\n    EXECUTE $sql$\n    CREATE INDEX IF NOT EXISTS idx_fact_content_last\n        ON dwh.fact_social_content_metrics (content_id, snapshot_date_id DESC);\n    $sql$;\n\n    -- Helpful for network + date range\n    EXECUTE $sql$\n    CREATE INDEX IF NOT EXISTS idx_fact_network_date\n        ON dwh.fact_social_content_metrics (social_network_id, snapshot_date_id);\n    $sql$;\n\n    -- 4.2 webpage_facts\n    EXECUTE $sql$\n    CREATE TABLE IF NOT EXISTS dwh.fact_web_traffic_metrics (\n        fact_id          BIGSERIAL PRIMARY KEY,\n\n        brand_id         BIGINT NOT NULL REFERENCES dwh.dim_brand(brand_id),\n        snapshot_date_id INTEGER NOT NULL REFERENCES dwh.dim_date(date_id),\n\n        metric_code      VARCHAR(50) NOT NULL,   -- 'Visitors', 'PageViews', 'SessionsCount'\n        value            NUMERIC,\n\n        source_endpoint  TEXT,\n        stats_from_utc   TIMESTAMPTZ,\n        stats_to_utc     TIMESTAMPTZ,\n        loaded_at_utc    TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n\n        CONSTRAINT uq_web_metric UNIQUE (brand_id, snapshot_date_id, metric_code)\n    );\n    $sql$;\n\n    EXECUTE $sql$\n    CREATE INDEX IF NOT EXISTS idx_web_brand_date\n        ON dwh.fact_web_traffic_metrics (brand_id, snapshot_date_id);\n    $sql$;\n\n    EXECUTE $sql$\n    CREATE INDEX IF NOT EXISTS idx_web_metric\n        ON dwh.fact_web_traffic_metrics (metric_code);\n    $sql$;\n\n    ----------------------------------------------------------------\n    -- 5. Seed dim_social_network (idempotent)\n    ----------------------------------------------------------------\n    EXECUTE $sql$\n    INSERT INTO dwh.dim_social_network (code, name, default_timezone) VALUES\n        ('LINKEDIN',  'LinkedIn',  'UTC'),\n        ('FACEBOOK',  'Facebook',  'UTC'),\n        ('INSTAGRAM', 'Instagram', 'UTC'),\n        ('TIKTOK',    'TikTok',    'UTC'),\n        ('YOUTUBE',   'YouTube',   'UTC'),\n        ('WEBPAGE',   'Webpage',   'UTC')\n    ON CONFLICT (code) DO NOTHING;\n    $sql$;\n\n    ----------------------------------------------------------------\n    -- 6. Populate/extend dim_date for the requested range (idempotent)\n    ----------------------------------------------------------------\n    d := p_start_date;\n\n    WHILE d <= p_end_date LOOP\n        -- date_id = YYYYMMDD\n        id_int := EXTRACT(YEAR FROM d)::int * 10000\n                + EXTRACT(MONTH FROM d)::int * 100\n                + EXTRACT(DAY FROM d)::int;\n\n        -- Business day_of_week: 1 = Sunday ... 7 = Saturday\n        -- Postgres EXTRACT(DOW): 0 = Sunday ... 6 = Saturday\n        dow_pg := CASE\n                    WHEN EXTRACT(DOW FROM d)::int = 0 THEN 1\n                    ELSE EXTRACT(DOW FROM d)::int + 1\n                  END;\n\n        -- First day of the year\n        year_start := DATE_TRUNC('year', d)::date;\n\n        -- DOW of Jan 1 in Postgres scale\n        dow_start := EXTRACT(DOW FROM year_start)::int;\n\n        -- First Sunday on or before Jan 1\n        first_sunday := year_start - dow_start;\n\n        -- Business week number (Sunday-based)\n        week := ((d - first_sunday)::int / 7) + 1;\n\n        INSERT INTO dwh.dim_date (\n            date_id, date, year, month, day,\n            quarter, week_of_year, day_of_week,\n            month_name, is_weekend\n        )\n        VALUES (\n            id_int,\n            d,\n            EXTRACT(YEAR FROM d)::int,\n            EXTRACT(MONTH FROM d)::int,\n            EXTRACT(DAY FROM d)::int,\n            EXTRACT(QUARTER FROM d)::int,\n            week,\n            dow_pg,\n            TO_CHAR(d, 'FMMonth'),\n            CASE WHEN dow_pg IN (1,7) THEN TRUE ELSE FALSE END\n        )\n        ON CONFLICT (date_id) DO NOTHING;\n\n        d := d + INTERVAL '1 day';\n    END LOOP;\n\nEND;\n$$;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        0,
        224
      ],
      "id": "a21e16c9-6513-4e2c-ac4e-6c89639f77a4",
      "name": "create stored procedure",
      "credentials": {
        "postgres": {
          "id": "re5OmKdxt35y8szi",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CALL sp_init_dwh('2022-01-01', '2030-12-31');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        208,
        0
      ],
      "id": "a9828fba-0e25-424a-aa0f-7d3694991898",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "re5OmKdxt35y8szi",
          "name": "Postgres account"
        }
      }
    }
  ],
  "connections": {
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "e8083f3b-59d1-4492-acea-3bdebf34bde9",
  "activeVersionId": null,
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-11-19T07:41:10.913Z",
      "createdAt": "2025-11-19T07:41:10.913Z",
      "role": "workflow:owner",
      "workflowId": "QHxX50oUriQOZZgh",
      "projectId": "bmvDuE1r6YNTedFD"
    }
  ],
  "activeVersion": null,
  "tags": []
}